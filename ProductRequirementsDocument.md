# 神马视频转换 — 需求文档

## 产品目标
- 提供简单高效的桌面视频批量处理工具，支持多格式转码、质量预设、旋转、剪切与视频增稳，面向普通用户与内容创作者。

## 目标用户与场景
- 自媒体创作者、视频爱好者、需要批量整理素材的个人用户。
- 场景：批量生成不同质量与格式的成片；对拍摄素材进行旋转、剪切与增稳处理。

## 运行环境
- 操作系统：Windows
- 打包分发：单文件 EXE（PyInstaller）
- 外部依赖：FFmpeg（随包或系统 PATH）

## 术语与约定
- “全局配置”：右侧区域的统一设置，用于批量刷写列表中所有行。
- “每行配置”：文件列表中每个文件的独立设置，最终执行以此为准。
- “同时任务数”：并发线程数（1-15）。
- “增稳等级”：0 表示关闭，1-35 表示强度（建议 30 以下）。

## 核心功能需求
- 文件管理
  - 添加文件：支持“添加文件”按钮、拖拽、文件表空白区域双击触发添加
  - 删除选中、清空列表（含确认弹窗）
  - 重复文件自动去重、显示序号/文件名/路径/大小/状态
  - 快速打开：Alt+左键单击在列表中快速打开所在目录；右键菜单打开位置；左键双击播放源文件
- 每行独立转码设置（最终执行依据）
  - 输出格式：MP4、MKV（可多选）
  - 压缩质量：无损、高清、平衡、小体积（可多选）
  - 旋转：保持、左旋 90°、右旋 90°、翻转 180°
  - 剪切：开始第 n 秒、倒数第 n 秒（默认为 0）
  - 增稳：0 关闭，1-35 为强度，建议 <30；开启会显著增加处理时间
- 全局配置（批量修改）
  - 修改全局设置时，立即同步更新列表中的所有文件行设置
  - 添加新文件时默认继承当前全局设置
  - 允许在列表中对某一行进行独立修改；开始转换时严格以每行当前显示为准
- 输出目录
  - 同文件夹目录与用户自定义目录（含目录选择与校验）
- 任务管理与执行
  - 生成任务：按每行“格式 × 质量”的组合生成多个任务
  - 任务列表列：序号、文件名（输出）、原路径、输出路径、进度、状态
  - 滚动跟随最新任务；右键双击任务行打开输出目录；双击已完成任务打开文件
  - 暂停/继续任务、取消所有任务、清空任务列表（运行中禁止清空）
  - 并发控制：滑块设置“同时任务数”（1-15）
- 文件命名规范
  - 输出文件名：原文件名_质量后缀.格式
  - 质量后缀映射：无损=Lossless，高清=HD，平衡=Balanced，小体积=Compact
- 程序图标与打包
  - EXE 图标与窗口图标使用 icon.ico
  - 为避免 Windows 图标缓存，打包后对 EXE 重命名并附加时间戳

## 非功能需求
- 性能与并发：使用线程池并行处理；UI 保持响应
- 易用性：清晰的标签、范围提示与确认弹窗；“使用说明”帮助对话框
- 兼容性：运行于 Windows；单文件 EXE 分发
- 健壮性：对路径与输入有效性进行校验；错误信息通过状态与 ToolTip 呈现
- 安全性：不存储或泄露敏感信息

## 交互细节
- 文件表：
  - 空白区域双击 → 打开添加对话框
  - Alt+左键单击 → 快速打开源文件或输出目录
  - 右键菜单 → 打开文件所在位置
- 任务表：
  - 右键双击 → 打开输出目录（定位到输出文件）
  - 左键双击（已完成） → 打开输出文件
  - “↓↓”按钮 → 自动跟随最新任务

## 编码质量映射（执行参数）
- 无损（Lossless）：CRF=0，preset=ultrafast
- 高清（HD）：CRF=18，preset=fast
- 平衡（Balanced）：CRF=23，preset=medium
- 小体积（Compact）：CRF=28，preset=slow

## 视频增稳与剪切
- 增稳处理：两阶段
  - 第一阶段 vidstabdetect（分析生成 .trf）
  - 第二阶段 vidstabtransform（应用并平滑，smoothing=增稳等级）
  - 处理结束后清理临时 .trf 文件
- 剪切：
  - 输入前寻址 -ss（更快）
  - 输出时长 -t；“倒数第 n 秒”需解析总时长

## 校验与边界条件
- 生成任务前必须至少选择一种格式与一种质量
- 自定义输出目录必须有效且可写
- 剪切输入默认为 "0"

## 错误与提示
- 转码失败 → 状态变为“转码失败”，任务行 ToolTip 显示错误信息
- 清空任务列表时若存在运行中或活跃任务 → 弹窗提示并禁止清空

## 帮助信息
- 帮助弹窗内容位于 [main.py](file:///d:/trea-ai/main.py#L90-L103) 的 show_help_dialog，可按需更新

## 未来拓展建议
- 增加“全局应用到全部”按钮用于一次性手动覆盖所有行
- 支持更多编码器与容器格式；质量预设可配置
- 任务队列管理（排队/暂停队列）；进度估算与剩余时间
- 配置持久化与国际化支持；GPU 编码

